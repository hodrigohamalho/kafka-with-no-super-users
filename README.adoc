= Kafka Laboratory with Podman (Red Hat AMQ Streams)
:toc:
:icons: font
:sectnums:

== üß± Overview

This lab demonstrates a complete setup of a *3-node Kafka cluster* with *ZooKeeper*, running on *RHEL containers with Podman*.
The focus is on *security, ACLs,* and the *broker behavior when no explicit topic permissions are configured*.

== ‚öôÔ∏è Environment and Versions

|===
| Component | Version / Image | Description
| Kafka | `registry.redhat.io/amq-streams/kafka-39-rhel9:3.0.1-2` | Red Hat AMQ Streams (Apache Kafka)
| ZooKeeper | Embedded in Kafka image | Metadata and quorum management
| Kafka UI | `provectuslabs/kafka-ui:latest` | Visual management console
| Host OS | macOS with *Podman* | Local environment
|===

== üß∞ The kafka.sh Control Script

The `kafka.sh` script orchestrates the creation, startup, and monitoring of the entire cluster.
It automates container lifecycle and provides an intuitive CLI.

=== Main Commands

[source,bash]
----
./kafka.sh container-setup         # Create network and volumes (idempotent)
./kafka.sh container-destroy       # Remove all containers, volumes, and network
./kafka.sh start [zks|brokers]     # Start ZooKeepers and Brokers
./kafka.sh stop [zks|brokers]      # Stop containers
./kafka.sh status                  # Show health and cluster mode
./kafka.sh logs                    # Tail logs from all containers
./kafka.sh topic_create <name> <partitions> <replication>  # Create topics
----

=== Cluster Modes

- *FULL* ‚Üí 3 ZooKeepers + 3 Brokers
- *MINIMAL* ‚Üí 1 ZooKeeper + 1 Broker (`--minimal` flag)

== ü™∂ Test Topics

Created for replication testing:

[source,bash]
----
./kafka.sh topic_create camel-book 6 3
./kafka.sh topic_create strimzi-book 6 3
----

These topics are used by a *Camel/Quarkus* app that continuously produces and consumes data.

== üß≠ Visual Console (Kafka UI)

Run the Kafka UI with Podman:

[source,bash]
----
podman run -d --name kafka-ui --network kafka-net -p 8000:8080   -e KAFKA_CLUSTERS_0_NAME=local   -e KAFKA_CLUSTERS_0_BOOTSTRAPSERVERS="kafka1:9092,kafka2:9092,kafka3:9092"   provectuslabs/kafka-ui
----

When SASL authentication was enabled, the UI used the *ops* user:

[source,bash]
----
-e KAFKA_CLUSTERS_0_PROPERTIES_SECURITY_PROTOCOL=SASL_PLAINTEXT -e KAFKA_CLUSTERS_0_PROPERTIES_SASL_MECHANISM=SCRAM-SHA-512 -e KAFKA_CLUSTERS_0_PROPERTIES_SASL_JAAS_CONFIG='org.apache.kafka.common.security.scram.ScramLoginModule required username="ops" password="ops-secret";'
----

== üîê Authentication and Users

SASL/SCRAM-SHA-512 authentication was enabled (without SSL for simplicity).

|===
| User | Role | Permissions / Notes
| broker | Internal communication | Inter-broker and ZK communication
| ops | Operations / UI | Broad permissions for management tools
| app | Application | Produces and consumes messages
|===

=== User Creation

[source,bash]
----
# Broker (inter-broker)
kafka-configs.sh --alter --add-config "SCRAM-SHA-512=[password=broker-secret]"   --entity-type users --entity-name broker

# Ops (tools)
kafka-configs.sh --alter --add-config "SCRAM-SHA-512=[password=ops-secret]"   --entity-type users --entity-name ops

# App (application)
kafka-configs.sh --alter --add-config "SCRAM-SHA-512=[password=app-secret]"   --entity-type users --entity-name app
----

== üîí ACL Matrix and Commands

The following table summarizes the permissions assigned to each user in this lab:

|===
| User | Resource | Operation | Permission Type | Description

| broker | Cluster | ClusterAction | ALLOW | Required for internal coordination and replication
| broker | Topic: `__*` | All | ALLOW | Internal topics (__consumer_offsets, __transaction_state)
| broker | Group: `*` | Read | ALLOW | To read group metadata during coordination

| ops | Cluster | All | ALLOW | Full operational access for management tools
| ops | Topic: `*` | All | ALLOW | View and manage all topics (Kafka UI)
| ops | Group: `*` | All | ALLOW | Manage consumer groups

| app | Topic: `camel-book` | Read, Write | ALLOW | Application produces and consumes data
| app | Topic: `strimzi-book` | Read, Write | ALLOW | Application produces and consumes data
| app | Group: `app-group` | Read | ALLOW | Allows consumption using a consumer group
|===

=== üßÆ ACL Commands

Below are the exact commands used to assign permissions.

[source,bash]
----
# === Broker internal permissions ===
kafka-acls.sh --authorizer-properties zookeeper.connect=zk1:2181,zk2:2181,zk3:2181 \
  --add --allow-principal User:broker \
  --operation ClusterAction --cluster

kafka-acls.sh --authorizer-properties zookeeper.connect=zk1:2181,zk2:2181,zk3:2181 \
  --add --allow-principal User:broker \
  --operation All --topic "__*"

# === Ops (administration) permissions ===
kafka-acls.sh --authorizer-properties zookeeper.connect=zk1:2181,zk2:2181,zk3:2181 \
  --add --allow-principal User:ops \
  --operation All --cluster --topic '*' --group '*'

# === App (application) permissions ===
kafka-acls.sh --authorizer-properties zookeeper.connect=zk1:2181,zk2:2181,zk3:2181 \
  --add --allow-principal User:app \
  --operation Read --operation Write \
  --topic camel-book --topic strimzi-book

kafka-acls.sh --authorizer-properties zookeeper.connect=zk1:2181,zk2:2181,zk3:2181 \
  --add --allow-principal User:app \
  --operation Read --group app-group
----

TIP: When SASL authentication is enabled, ACLs can also be managed using `--bootstrap-server` instead of ZooKeeper connection.

=== üß© ACL Testing

Even after explicitly *DENYing* read and write operations, the cluster continued functioning, confirming that:

> Internal broker operations do not require explicit Read/Write ACLs for normal functioning.

== ‚úÖ Conclusion

This lab shows that:
- A Kafka cluster can run fully in Podman containers using SASL authentication.
- Brokers work correctly *without explicit Read/Write permissions*.
- Replication continues properly even under restrictive ACL configurations.

== üß© Next Steps

- Validate the same behavior in *KRaft mode* (no ZooKeeper).
- Add Prometheus + Grafana monitoring.
- Automate user and ACL creation inside `kafka.sh`.
